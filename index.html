<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像素果</title>

    <link rel="icon" href="./Logo/Logo.png" type="image/png">
    
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    
    <div class="container">
        <!-- 左侧面板：文件上传和基本设置 -->
        <div class="left-panel">
            <div class="panel">
                <div class="panel-header">
                    <h3>文件上传</h3>
                </div>
                <div class="file-input">
                    <input type="file" id="raw-file" accept=".cr2,.nef,.arw,.dng,.raw,.rw2">
                    <label for="raw-file" class="file-input-label">选择 RAW 文件</label>
                    <div class="file-name" id="file-name">未选择文件</div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <h3>基本设置</h3>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="use-auto-wb" checked>
                        自动白平衡
                    </label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="use-camera-wb">
                        相机白平衡
                    </label>
                </div>
                <div class="button-group">
                    <button id="fullscreen-view-button" class="fullscreen-button" disabled>查看大屏图片</button>
                </div>
                <div class="slider-group">
                    <label for="brightness">亮度</label>
                    <div class="slider-wrapper">
                        <input type="range" id="brightness" min="0.1" max="4" step="0.1" value="1">
                        <span class="value-display" id="brightness-value">1.0</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label for="exposure">曝光补偿</label>
                    <div class="slider-wrapper">
                        <input type="range" id="exposure" min="-2" max="2" step="0.1" value="0">
                        <span class="value-display" id="exposure-value">0.0</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label for="saturation">饱和度</label>
                    <div class="slider-wrapper">
                        <input type="range" id="saturation" min="0" max="300" step="1" value="100">
                        <span class="value-display" id="saturation-value">100</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label for="contrast">对比度</label>
                    <div class="slider-wrapper">
                        <input type="range" id="contrast" min="-50" max="50" step="1" value="0">
                        <span class="value-display" id="contrast-value">0</span>
                    </div>
                </div>
                
                <!-- 滤镜选择器 -->
                <div class="filter-group">
                    <label for="filter-select">预设滤镜</label>
                    <div class="filter-controls">
                        <select id="filter-select" class="filter-select">
                            <option value="none">无滤镜</option>
                        </select>
                        <button id="save-filter-button" class="save-filter-button" disabled>保存当前配置</button>
                    </div>
                </div>
                <div class="button-group">
                    <button id="reset-button" class="reset-button" disabled>重置</button>
                    <button id="export-png-button" class="export-button" disabled>导出 PNG</button>
                    <button id="export-jpeg-button" class="export-button" disabled>导出 JPEG</button>
                </div>
            </div>
        </div>
        
        <!-- 中间面板：图像显示 -->
        <div class="center-panel">
            <div class="image-container">
                <canvas id="image-canvas"></canvas>
                <div class="status-message" id="status-message">请上传 RAW 文件以查看图像</div>
            </div>
        </div>
        
        <!-- 右侧面板：高级设置 -->
        <div class="right-panel">
            <div class="panel">
                <div class="tabs">
                    <button class="tab active" data-tab="color">颜色调整</button>
                    <button class="tab" data-tab="detail">细节处理</button>
                    <button class="tab" data-tab="color-replace">颜色替换</button>
                </div>
                
                <div class="tab-content active" id="color-tab">
                    <div class="color-adjustments">
                        <div class="color-slider">
                            <label for="red-tint">红色色调</label>
                            <div class="slider-wrapper">
                                <input type="range" id="red-tint" min="-100" max="100" step="1" value="0">
                                <span class="value-display" id="red-tint-value">0</span>
                            </div>
                        </div>
                        <div class="color-slider">
                            <label for="green-tint">绿色色调</label>
                            <div class="slider-wrapper">
                                <input type="range" id="green-tint" min="-100" max="100" step="1" value="0">
                                <span class="value-display" id="green-tint-value">0</span>
                            </div>
                        </div>
                        <div class="color-slider">
                            <label for="blue-tint">蓝色色调</label>
                            <div class="slider-wrapper">
                                <input type="range" id="blue-tint" min="-100" max="100" step="1" value="0">
                                <span class="value-display" id="blue-tint-value">0</span>
                            </div>
                        </div>
                        <div class="color-slider">
                            <label for="highlights">高光</label>
                            <div class="slider-wrapper">
                                <input type="range" id="highlights" min="-50" max="50" step="1" value="0">
                                <span class="value-display" id="highlights-value">0</span>
                            </div>
                        </div>
                        <div class="color-slider">
                            <label for="shadows">阴影</label>
                            <div class="slider-wrapper">
                                <input type="range" id="shadows" min="-50" max="50" step="1" value="0">
                                <span class="value-display" id="shadows-value">0</span>
                            </div>
                        </div>
                        <div class="color-slider">
                            <label for="whites">白色</label>
                            <div class="slider-wrapper">
                                <input type="range" id="whites" min="0" max="100" step="1" value="100">
                                <span class="value-display" id="whites-value">100</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="detail-tab">
                    <div class="detail-controls">
                        <div class="slider-group">
                        <label for="sharpness">锐化</label>
                        <div class="slider-wrapper">
                            <input type="range" id="sharpness" min="0" max="100" step="1" value="0">
                            <span class="value-display" id="sharpness-value">0</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label for="noise-reduction">减少杂色</label>
                        <div class="slider-wrapper">
                            <input type="range" id="noise-reduction" min="0" max="100" step="1" value="0">
                            <span class="value-display" id="noise-reduction-value">0</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label for="noise-reduction-type">降噪算法</label>
                        <select id="noise-reduction-type" class="control-select">
                            <option value="mean">均值滤波 (标准)</option>
                            <option value="median">中值滤波 (椒盐噪点)</option>
                            <option value="gaussian">高斯滤波 (平滑)</option>
                        </select>
                    </div>
                    <div class="slider-group">
                        <label for="detail-preservation">细节保留</label>
                        <div class="slider-wrapper">
                            <input type="range" id="detail-preservation" min="0" max="100" step="1" value="50">
                            <span class="value-display" id="detail-preservation-value">50</span>
                        </div>
                    </div>

                    <div class="slider-group">
                        <label for="texture">纹理/清晰度</label>
                        <div class="slider-wrapper">
                            <input type="range" id="texture" min="-50" max="50" step="1" value="0">
                            <span class="value-display" id="texture-value">0</span>
                        </div>
                    </div>
                    
                    <div class="slider-group">
                        <label for="face-brightening">面部美白</label>
                        <div class="slider-wrapper">
                            <input type="range" id="face-brightening" min="0" max="100" step="1" value="0">
                            <span class="value-display" id="face-brightening-value">0</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label for="face-smoothness">过渡平滑度</label>
                        <div class="slider-wrapper">
                            <input type="range" id="face-smoothness" min="0" max="100" step="1" value="50">
                            <span class="value-display" id="face-smoothness-value">50</span>
                        </div>
                    </div>
                    </div>
                </div>
                
                <div class="tab-content" id="color-replace-tab">
                    <div class="color-replace-controls">
                        <!-- 颜色范围选择器 -->
                        <div class="color-range-selector">
                            <h4>颜色范围选择</h4>
                            <div class="color-inputs">
                                <div class="color-input-group">
                                    <input type="color" id="color-range-start" value="#ff0000" class="transparent">
                                    <label for="color-range-start">起始颜色</label>
                                </div>
                                <div class="color-input-group">
                                    <input type="color" id="color-range-end" value="#0000ff" class="transparent">
                                    <label for="color-range-end">结束颜色</label>
                                </div>
                            </div>
                            
                            <!-- 渐变滑块 -->
                            <div class="range-wrapper" id="colorRangeContainer">
                                <div class="gradient-track" id="colorGradientTrack"></div>
                                <input type="range" id="colorSlider1" class="range-slider transparent" min="0" max="100" value="0">
                                <input type="range" id="colorSlider2" class="range-slider transparent" min="0" max="100" value="100">
                            </div>
                            
                        </div>
                        
                        <!-- 目标颜色范围设置 -->
                        <div class="target-color-settings">
                            <h4>目标颜色范围</h4>
                            <div class="color-inputs">
                                <div class="color-input-group">
                                    <input type="color" id="target-color-start" value="#00ff00" class="transparent">
                                    <label for="target-color-start">目标起始颜色</label>
                                </div>
                                <div class="color-input-group">
                                    <input type="color" id="target-color-end" value="#ffff00" class="transparent">
                                    <label for="target-color-end">目标结束颜色</label>
                                </div>
                            </div>
                            
                            <!-- 目标颜色渐变轨道 -->
                            <div class="range-wrapper" id="targetColorRangeContainer">
                                <div class="gradient-track" id="targetColorGradientTrack"></div>
                            </div>
                            
                            <div class="mix-ratio">
                                <label for="mixRatio">替换强度</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="mixRatio" min="0" max="100" step="1" value="100">
                                    <span class="value-display" id="mixRatio-value">100%</span>
                                </div>
                            </div>
                            
                            <div class="tolerance-setting">
                                <label for="colorTolerance">颜色容差</label>
                                <div class="slider-wrapper">
                                    <input type="range" id="colorTolerance" min="10" max="200" step="5" value="60">
                                    <span class="value-display" id="colorTolerance-value">60</span>
                                </div>
                                <div class="tolerance-description">
                                    <small>容差值越小，颜色匹配越精确；容差值越大，匹配范围越广</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="color-replace-actions">
                            <button id="previewColorReplace" class="action-button">预览效果</button>
                            <button id="applyColorReplace" class="action-button primary">应用替换</button>
                            <button id="undoColorReplace" class="action-button">撤销</button>
                        </div>
                        
                        <!-- 处理结果 -->
                        <div class="color-replace-result" id="colorReplaceResult" style="display: none;">
                            <div class="result-info">
                                <span id="replacedPixelsCount">0</span> 个像素已替换
                            </div>
                        </div>
                        
                        <!-- 颜色替换历史表格 -->
                        <div class="color-replace-history">
                            <h4>替换历史</h4>
                            <div class="history-table-container">
                                <table id="colorReplaceTable" class="history-table">
                                    <thead>
                                        <tr>
                                            <th>起始颜色</th>
                                            <th>结束颜色</th>
                                            <th>目标起始颜色</th>
                                            <th>目标结束颜色</th>
                                            <th>替换强度</th>
                                            <th>容差</th>
                                            <th>替换像素</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="colorReplaceTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="image-detail-panel" class="image-detail-panel">
                <div class="detail-header">
                    <h4>图片细节</h4>
                </div>
                <div class="detail-content">
                    <div class="zoom-preview">
                        <canvas id="zoom-canvas" width="200" height="200"></canvas>
                    </div>
                    <div class="pixel-info">
                        <div class="info-item">
                            <span class="label">位置:</span>
                            <span class="value" id="pixel-position">请上传图片</span>
                        </div>
                        <div class="info-item">
                            <span class="label">RGB:</span>
                            <span class="value" id="pixel-rgb">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">亮度:</span>
                            <span class="value" id="pixel-brightness">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">色相:</span>
                            <span class="value" id="pixel-hue">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="histogram-panel">
                <div class="panel">
                    <div class="panel-header">
                        <h3>直方图</h3>
                        <div class="histogram-controls">
                            <button class="histogram-btn active" data-mode="luminance">亮度</button>
                            <button class="histogram-btn" data-mode="rgb">RGB</button>
                        </div>
                    </div>
                    <canvas id="histogram-canvas"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <h3>图像元数据</h3>
                </div>
                <div class="metadata" id="metadata-output">请上传 RAW 文件以查看元数据</div>
            </div>
        </div>
    </div>

    <script type="module">
        import LibRaw from './index.js';
        import { initColorModule, applyColorAdjustments, updateWhiteBalanceCoefficients, applyContrast, registerColorEventListeners } from './Files/color.js';
        import { applyUnsharpMask, applySharpness, applyNoiseReduction, applyFaceBrightening } from './Files/Details.js';
        import { initSliderManager, addSliderEventListenersBatch } from './Files/SliderManager.js';
        import { drawEmptyHistogram, optimizedUpdateHistogram, createDebouncedHistogramUpdate } from './Files/HistogramManager.js';
        import { exportImage, exportPNG, exportJPEG } from './Files/exportImage.js';
        import { initColorReplace } from './Files/Replacecolor.js';
        import { initFilterModule } from './Files/Filter.js';
        import { initChartModule } from './Files/Chart.js';
        
        // 获取DOM元素
        const rawFileInput = document.getElementById('raw-file');
        const fileName = document.getElementById('file-name');
        const metadataOutput = document.getElementById('metadata-output');
        const canvas = document.getElementById('image-canvas');
        // 明确指定使用sRGB颜色空间，确保渲染和导出时颜色处理一致
        const ctx = canvas.getContext('2d', { colorSpace: 'srgb' });
        const statusMessage = document.getElementById('status-message');
        const resetButton = document.getElementById('reset-button');
        const exportPngButton = document.getElementById('export-png-button');
        const exportJpegButton = document.getElementById('export-jpeg-button');
        const fullscreenViewButton = document.getElementById('fullscreen-view-button');
        const imageDetailPanel = document.getElementById('image-detail-panel');
        const zoomCanvas = document.getElementById('zoom-canvas');
        const pixelPosition = document.getElementById('pixel-position');
        const pixelRgb = document.getElementById('pixel-rgb');
        const pixelBrightness = document.getElementById('pixel-brightness');
        const pixelHue = document.getElementById('pixel-hue');
        
        // 图片细节面板状态
        let isDetailFixed = false;
        let fixedPosition = { x: 0, y: 0 };
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE = 16; // 约60fps的更新频率
        
        // 获取所有控件元素
        const useAutoWbCheckbox = document.getElementById('use-auto-wb');
        const useCameraWbCheckbox = document.getElementById('use-camera-wb');
        const brightnessSlider = document.getElementById('brightness');
        const brightnessValue = document.getElementById('brightness-value');
        const exposureSlider = document.getElementById('exposure');
        const exposureValue = document.getElementById('exposure-value');
        const saturationSlider = document.getElementById('saturation');
        const saturationValue = document.getElementById('saturation-value');
        const sharpnessSlider = document.getElementById('sharpness');
        const sharpnessValue = document.getElementById('sharpness-value');
        const noiseReductionSlider = document.getElementById('noise-reduction');
        const noiseReductionValue = document.getElementById('noise-reduction-value');
        const textureSlider = document.getElementById('texture');
        const textureValue = document.getElementById('texture-value');
        const contrastSlider = document.getElementById('contrast');
        const contrastValue = document.getElementById('contrast-value');
        const redTintSlider = document.getElementById('red-tint');
        const greenTintSlider = document.getElementById('green-tint');
        const blueTintSlider = document.getElementById('blue-tint');
        const redTintValue = document.getElementById('red-tint-value');
        const greenTintValue = document.getElementById('green-tint-value');
        const blueTintValue = document.getElementById('blue-tint-value');
        const highlightsSlider = document.getElementById('highlights');
        const highlightsValue = document.getElementById('highlights-value');
        const shadowsSlider = document.getElementById('shadows');
        const shadowsValue = document.getElementById('shadows-value');
        const whitesSlider = document.getElementById('whites');
        const whitesValue = document.getElementById('whites-value');
        const noiseReductionTypeSelect = document.getElementById('noise-reduction-type');
        const detailPreservationSlider = document.getElementById('detail-preservation');
        const detailPreservationValue = document.getElementById('detail-preservation-value');
        const faceBrighteningSlider = document.getElementById('face-brightening');
        const faceBrighteningValue = document.getElementById('face-brightening-value');
        const faceSmoothnessSlider = document.getElementById('face-smoothness');
        const faceSmoothnessValue = document.getElementById('face-smoothness-value');
        const filterSelect = document.getElementById('filter-select');
        const saveFilterButton = document.getElementById('save-filter-button');
        
        // 标签页相关元素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
    
        // 创建colorElements对象并传递给color.js模块
        const colorElements = {
            brightnessSlider,
            brightnessValue,
            exposureSlider,
            exposureValue,
            saturationSlider,
            saturationValue,
            contrastSlider,
            contrastValue,
            redTintSlider,
            greenTintSlider,
            blueTintSlider,
            redTintValue,
            greenTintValue,
            blueTintValue,
            highlightsSlider,
            highlightsValue,
            shadowsSlider,
            shadowsValue,
            whitesSlider,
            whitesValue
        };
        
        // 初始化颜色模块
        initColorModule(colorElements);
        
        // 存储默认设置
        const defaultSettings = {
            use_auto_wb: 1,
            use_camera_wb: 0,
            bright: 1.0,
            exp_shift: 0.0,
            user_sat: 100,
            fbdd_noiserd: 0,
            user_mul: [1.0, 1.0, 1.0, 1.0],
            output_color: 1,
            output_bps: 8,
            half_size: 0,
            exp_correc: 1,
            adjust_maximum_thr: 0.75,
            shadows: 0
        };
        
      
        
        // 配置参数
        let settings = { ...defaultSettings };
        
        // 存储当前的文件数据
        let currentFileBuffer = null;
        // 缓存处理后的图像数据
        let cachedImageData = null;
        // 颜色替换后的基准图像数据（用于基本设置调整的基准）
        let colorReplaceBaseImageData = null;
        
        // 降噪相关的当前设置
        let currentNoiseReductionSettings = {
            type: 'mean',
            detailPreservation: 50
        };

        // 创建 LibRaw 实例
        const libraw = new LibRaw();
        
        // 从Basic.js导入基础功能函数，为debounce添加别名避免冲突
        const { debounce: debounceUtil, readFileAsArrayBuffer, updateImageFromCache: basicUpdateImageFromCache } = await import('./Files/Basic.js');
        
        
        // 全局变量保存当前选择的文件对象
        let currentSelectedFile;
        
        
        
        // 智能防抖图像处理函数
        const debouncedImageUpdate = debounceUtil(async () => {
            if (cachedImageData) {
                await updateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
                
                // 更新直方图
                if (window.chartManager) {
                    window.chartManager.forceUpdateHistogram();
                }
                refreshImageDetails();
            }
        }, 80); // 减少防抖延迟，提高响应性
        
        // 创建包含直方图更新的统一更新函数
        const debouncedImageUpdateWithHistogram = debounceUtil(async () => {
            if (cachedImageData) {
                await updateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
                
                // 更新直方图
                if (window.chartManager) {
                    window.chartManager.forceUpdateHistogram();
                }
                refreshImageDetails();
            }
        }, 80);
        
        // 用于检测滑块是否正在拖动的标志
        let isSliderDragging = false;
        
        // 监听锐化滑块的mousedown和mouseup事件
        sharpnessSlider.addEventListener('mousedown', () => {
            isSliderDragging = true;
        });
        
        sharpnessSlider.addEventListener('mouseup', () => {
            isSliderDragging = false;
            // 拖动结束后立即应用一次完整处理
            debouncedImageUpdateWithHistogram();
        });
        
        // 同样监听触摸事件（移动设备）
        sharpnessSlider.addEventListener('touchstart', () => {
            isSliderDragging = true;
        });
        
        sharpnessSlider.addEventListener('touchend', () => {
            isSliderDragging = false;
            // 拖动结束后立即应用一次完整处理
            debouncedImageUpdateWithHistogram();
        });
        
        // 暴露isSliderDragging标志供Details.js使用
        window.isSliderDragging = () => isSliderDragging;
        
     
        
        // 完全重置所有参数到默认值
        function resetAllParametersToDefault() {
            // 重置基础设置
            brightnessSlider.value = 1.0;
            brightnessValue.textContent = '1.0';
            settings.bright = 1.0;
            
            exposureSlider.value = 0;
            exposureValue.textContent = '0.0';
            settings.exp_shift = 0;
            
            saturationSlider.value = 100;
            saturationValue.textContent = '100';
            settings.user_sat = 100;
            
            contrastSlider.value = 0;
            contrastValue.textContent = '0';
            settings.contrast = 0;
            
            // 重置颜色调整
            highlightsSlider.value = 0;
            highlightsValue.textContent = '0';
            settings.highlights = 0;
            
            shadowsSlider.value = 0;
            shadowsValue.textContent = '0';
            settings.shadows = 0;
            
            redTintSlider.value = 0;
            redTintValue.textContent = '0';
            settings.redTint = 0;
            
            greenTintSlider.value = 0;
            greenTintValue.textContent = '0';
            settings.greenTint = 0;
            
            blueTintSlider.value = 0;
            blueTintValue.textContent = '0';
            settings.blueTint = 0;
            
            whitesSlider.value = 100;
            whitesValue.textContent = '100';
            settings.whites = 100;
            
            // 重置白平衡设置
            settings.user_mul = [1.0, 1.0, 1.0, 1.0];
            
            // 重置细节处理
            sharpnessSlider.value = 0;
            sharpnessValue.textContent = '0';
            settings.sharpness = 0;
            
            noiseReductionSlider.value = 0;
            noiseReductionValue.textContent = '0';
            settings.fbdd_noiserd = 0;
            
            textureSlider.value = 0;
            textureValue.textContent = '0';
            
            // 重置面部提亮
            faceBrighteningSlider.value = 0;
            faceBrighteningValue.textContent = '0';
            settings.faceBrightening = 0;
            
            faceSmoothnessSlider.value = 50;
            faceSmoothnessValue.textContent = '50';
            settings.faceSmoothness = 50;
            
            
            // 重置白平衡复选框
            useAutoWbCheckbox.checked = true;
            useCameraWbCheckbox.checked = false;
            settings.use_auto_wb = 1;
            settings.use_camera_wb = 0;
            
            // 重置降噪设置
            currentNoiseReductionSettings = {
                type: 'mean',
                detailPreservation: 50
            };
            detailPreservationSlider.value = 50;
            detailPreservationValue.textContent = '50';
            noiseReductionTypeSelect.value = 'mean';
        }


        // 处理缓存和优化
        let lastProcessedSettings = null;
        let processedImageData = null;
        
        // 应用调整到缓存数据（优化版）
        function applyAdjustmentsToCachedData(data, width, height) {
            // 创建当前设置的快照
            const currentSettings = {
                bright: settings.bright,
                exp_shift: settings.exp_shift,
                user_sat: settings.user_sat,
                contrast: settings.contrast !== undefined ? settings.contrast : parseInt(contrastSlider.value),
                highlights: settings.highlights !== undefined ? settings.highlights : parseInt(highlightsSlider.value),
                shadows: settings.shadows !== undefined ? settings.shadows : parseInt(shadowsSlider.value),
                whites: settings.whites !== undefined ? settings.whites : parseInt(whitesSlider.value),
                sharpness: settings.sharpness !== undefined ? settings.sharpness : parseInt(sharpnessSlider.value),
                fbdd_noiserd: settings.fbdd_noiserd !== undefined ? settings.fbdd_noiserd : parseInt(noiseReductionSlider.value),
                noiseType: currentNoiseReductionSettings.type,
                detailPreservation: currentNoiseReductionSettings.detailPreservation,
                faceBrightening: settings.faceBrightening !== undefined ? settings.faceBrightening : parseInt(faceBrighteningSlider.value),
                faceSmoothness: settings.faceSmoothness !== undefined ? settings.faceSmoothness : parseInt(faceSmoothnessSlider.value),
                user_mul: [...settings.user_mul],
                redTint: settings.redTint || 0,
                greenTint: settings.greenTint || 0,
                blueTint: settings.blueTint || 0
            };
            
            // 检查是否有颜色替换历史记录
            const hasColorReplacements = window.getColorReplaceHistory && window.getColorReplaceHistory().length > 0;
            
            // 如果有颜色替换，使用颜色替换后的基准数据，避免累积处理
            if (hasColorReplacements) {
                if (colorReplaceBaseImageData && colorReplaceBaseImageData.data) {
                    // 使用颜色替换后的基准数据，避免累积调整
                    data.set(colorReplaceBaseImageData.data);
                    console.log('使用颜色替换基准数据，避免累积处理');
                } else {
                    // 如果没有基准数据，从当前Canvas获取（首次处理）
                    if (canvas.width > 0 && canvas.height > 0) {
                        try {
                            const currentCanvasData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            if (currentCanvasData && currentCanvasData.data && currentCanvasData.data.length > 0) {
                                data.set(currentCanvasData.data);
                                console.log('首次处理，从当前Canvas状态开始');
                            } else {
                                console.warn('Canvas数据无效，使用原始缓存数据');
                            }
                        } catch (error) {
                            console.error('从Canvas获取数据失败:', error);
                            console.warn('使用原始缓存数据');
                        }
                    } else {
                        console.warn('Canvas尺寸无效，使用原始缓存数据');
                    }
                }
            }
            
            // 检查设置是否发生变化
            const settingsChanged = !lastProcessedSettings || 
                JSON.stringify(currentSettings) !== JSON.stringify(lastProcessedSettings);
            
            if (!settingsChanged && processedImageData && !hasColorReplacements) {
                // 如果设置没有变化且有缓存，且没有颜色替换，直接使用缓存数据
                data.set(processedImageData);
                return;
            }
            
            // 记录处理开始时间
            const startTime = performance.now();
            
            // 获取处理参数
            const sharpness = currentSettings.sharpness;
            const noiseReduction = currentSettings.fbdd_noiserd;
            const faceBrightening = currentSettings.faceBrightening || 0;
            const faceSmoothness = currentSettings.faceSmoothness || 50;
            const needSharpness = sharpness > 0;
            const needNoiseReduction = noiseReduction > 0;
            const needFaceBrightening = faceBrightening > 0;
            
            // 应用颜色调整（从color.js模块）
            // 注意：即使有颜色替换，也需要应用基本设置，因为颜色替换只影响特定颜色范围
            applyColorAdjustments(data, width, height, settings);
            
            // 先应用降噪
            if (needNoiseReduction) {
                applyNoiseReduction(
                    data, 
                    width, 
                    height, 
                    noiseReduction, 
                    currentSettings.noiseType,
                    currentSettings.detailPreservation
                );
            }
            
            // 然后应用锐化（在所有其他调整之后进行）
            if (needSharpness) {
                applySharpness(data, width, height, sharpness);
            }
            
            // 应用面部提亮
            if (needFaceBrightening) {
                applyFaceBrightening(data, width, height, faceBrightening, faceSmoothness);
            }
            
            // 缓存处理结果（只有在没有颜色替换时才缓存，避免缓存被颜色替换覆盖）
            if (!hasColorReplacements) {
                if (!processedImageData) {
                    processedImageData = new Uint8ClampedArray(data.length);
                }
                processedImageData.set(data);
                lastProcessedSettings = currentSettings;
            }
            
            // 记录处理时间
            const endTime = performance.now();
            if (endTime - startTime > 10) { // 只记录耗时超过10ms的处理
                console.log(`图像处理耗时: ${(endTime - startTime).toFixed(2)}ms`);
            }
            
            // 刷新图片细节显示，确保显示最新的像素信息
            refreshImageDetails();
        }
        




        
        // 监听文件选择
        rawFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            // 保存当前选择的文件对象
            currentSelectedFile = file;
            
            // 显示文件名
            fileName.textContent = file.name;
            
            try {
                // 读取文件数据
                const arrayBuffer = await readFileAsArrayBuffer(file);
                
                // 创建一个 Uint8Array 视图用于传递给 Web Worker
                currentFileBuffer = new Uint8Array(arrayBuffer);
                
                // 启用按钮
                resetButton.disabled = false;
                exportPngButton.disabled = false;
                exportJpegButton.disabled = false;
                fullscreenViewButton.disabled = false;
                
                // 显示处理状态
                statusMessage.textContent = '正在处理 RAW 文件...';
                metadataOutput.textContent = '正在提取元数据...';
                
                // 使用新设置重新打开文件
                await libraw.open(currentFileBuffer, settings);
                
                // 获取元数据
                const metadata = await libraw.metadata(true);
                metadataOutput.textContent = JSON.stringify(metadata, null, 2);
                
                // 获取并缓存图像数据
                try {
                    const imageData = await libraw.imageData();
                    if (imageData && imageData.data) {
                        // 处理RGB转RGBA的通道转换
                        let rgbaData = imageData.data;
                        if (imageData.colors === 3) {
                            // RGB转RGBA
                            rgbaData = new Uint8ClampedArray(imageData.data.length * 4 / 3);
                            for (let i = 0, j = 0; i < imageData.data.length; i += 3, j += 4) {
                                rgbaData[j] = imageData.data[i];     // R
                                rgbaData[j + 1] = imageData.data[i + 1]; // G
                                rgbaData[j + 2] = imageData.data[i + 2]; // B
                                rgbaData[j + 3] = 255;              // A (不透明)
                            }
                        }
                        
                        // 创建缓存的ImageData对象
                        cachedImageData = {
                            data: new Uint8ClampedArray(rgbaData),
                            width: imageData.width,
                            height: imageData.height
                        };
                    }
                } catch (error) {
                    console.error('缓存图像数据失败:', error);
                }
            // 显示初始图像
            await updateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
                
                // 隐藏处理状态
                statusMessage.textContent = '处理完成';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
                
                // 刷新图片细节显示
                refreshImageDetails();
                
                // 更新直方图
                if (window.chartManager) {
                    window.chartManager.forceUpdateHistogram();
                }
            } catch (error) {
                console.error('处理文件时出错:', error);
                statusMessage.textContent = '处理失败';
                metadataOutput.textContent = `处理文件时出错: ${error.message}`;
            }
        });
        
        // 重置按钮点击事件
        resetButton.addEventListener('click', () => {
            // 重置设置
            settings = { ...defaultSettings };
            
            // 重置控件值
            useAutoWbCheckbox.checked = true;
            useCameraWbCheckbox.checked = false;
            brightnessSlider.value = 1.0;
            brightnessValue.textContent = '1.0';
            exposureSlider.value = 0.0;
            exposureValue.textContent = '0.0';
            saturationSlider.value = 100;
            saturationValue.textContent = '100';
            sharpnessSlider.value = 0;
            sharpnessValue.textContent = '0';
            noiseReductionSlider.value = 0;
            noiseReductionValue.textContent = '0';
            noiseReductionTypeSelect.value = 'mean';
            detailPreservationSlider.value = 50;
            detailPreservationValue.textContent = '50';
            textureSlider.value = 0;
            textureValue.textContent = '0';
            faceBrighteningSlider.value = 0;
            faceBrighteningValue.textContent = '0';
            faceSmoothnessSlider.value = 50;
            faceSmoothnessValue.textContent = '50';
            contrastSlider.value = 0;
            contrastValue.textContent = '0';
            redTintSlider.value = 0;
            greenTintSlider.value = 0;
            blueTintSlider.value = 0;
            highlightsSlider.value = 0;
            shadowsSlider.value = 0;
            whitesSlider.value = 100;
            whitesValue.textContent = '100';
            
            // 重置降噪设置
            currentNoiseReductionSettings = {
                type: 'mean',
                detailPreservation: 50
            };
            
            // 重新应用设置
            updateImageWithNewSettings();
        });
    
        
        // 初始化降噪相关控件的值显示
        detailPreservationValue.textContent = detailPreservationSlider.value;
        
        // 初始化滑块管理器
        initSliderManager();
        
        // 初始化颜色替换功能
        const colorReplaceElements = {
            colorRangeStart: document.getElementById('color-range-start'),
            colorRangeEnd: document.getElementById('color-range-end'),
            colorSlider1: document.getElementById('colorSlider1'),
            colorSlider2: document.getElementById('colorSlider2'),
            colorGradientTrack: document.getElementById('colorGradientTrack'),
            colorRangeContainer: document.getElementById('colorRangeContainer'),
            targetColorStart: document.getElementById('target-color-start'),
            targetColorEnd: document.getElementById('target-color-end'),
            targetColorGradientTrack: document.getElementById('targetColorGradientTrack'),
            targetColorRangeContainer: document.getElementById('targetColorRangeContainer'),
            mixRatio: document.getElementById('mixRatio'),
            mixRatioValue: document.getElementById('mixRatio-value'),
            colorTolerance: document.getElementById('colorTolerance'),
            colorToleranceValue: document.getElementById('colorTolerance-value'),
            previewColorReplace: document.getElementById('previewColorReplace'),
            applyColorReplace: document.getElementById('applyColorReplace'),
            undoColorReplace: document.getElementById('undoColorReplace'),
            colorReplaceResult: document.getElementById('colorReplaceResult'),
            replacedPixelsCount: document.getElementById('replacedPixelsCount'),
            colorReplaceTableBody: document.getElementById('colorReplaceTableBody')
        };
        
        const colorReplaceCanvas = {
            ctx: ctx,
            canvas: canvas
        };
        
        // 初始化颜色替换功能
        initColorReplace(colorReplaceElements, colorReplaceCanvas, debouncedImageUpdate);
        
        // 使用SliderManager批量添加滑块事件监听器
        addSliderEventListenersBatch([
            {
                element: brightnessSlider,
                callback: (e) => {
                    settings.bright = parseFloat(e.target.value);
                    brightnessValue.textContent = settings.bright.toFixed(1);
                    debouncedImageUpdateWithHistogram();
                }
            },
            {
                element: exposureSlider,
                callback: (e) => {
                    settings.exp_shift = parseFloat(e.target.value);
                    exposureValue.textContent = settings.exp_shift.toFixed(1);
                    debouncedImageUpdateWithHistogram();
                }
            },
            {
                element: noiseReductionSlider,
                callback: (e) => {
                    settings.fbdd_noiserd = parseInt(e.target.value);
                    noiseReductionValue.textContent = settings.fbdd_noiserd;
                    debouncedImageUpdateWithHistogram();
                }
            },
            {
                element: noiseReductionTypeSelect,
                callback: (e) => {
                    currentNoiseReductionSettings.type = e.target.value;
                    debouncedImageUpdateWithHistogram();
                },
                eventType: 'change'
            },
            {
                element: detailPreservationSlider,
                callback: (e) => {
                    currentNoiseReductionSettings.detailPreservation = parseInt(e.target.value);
                    detailPreservationValue.textContent = currentNoiseReductionSettings.detailPreservation;
                    debouncedImageUpdateWithHistogram();
                }
            }
        ]);
        
 
        
        // 标签页切换
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有活动状态
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // 添加当前活动状态
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
        

        
        // 防抖处理颜色调整
        const debouncedColorUpdate = debounceUtil(() => {
            updateWhiteBalanceCoefficients(settings);
            // 无论是否有缓存数据，都触发图像更新
            debouncedImageUpdateWithHistogram();
        }, 150); // 减少延迟到150ms，提高响应速度
        
        // 使用 color.js 中的函数注册所有颜色调整事件监听器
        registerColorEventListeners(settings, debouncedImageUpdateWithHistogram, debouncedColorUpdate);
        
        // 使用SliderManager添加剩余滑块的事件监听器
        addSliderEventListenersBatch([
            {
                element: sharpnessSlider,
                callback: (e) => {
                    sharpnessValue.textContent = e.target.value;
                    debouncedImageUpdateWithHistogram();
                }
            },
            {
                element: textureSlider,
                callback: (e) => {
                    textureValue.textContent = e.target.value;
                    debouncedImageUpdateWithHistogram();
                }
            },
            {
                element: faceBrighteningSlider,
                callback: (e) => {
                    settings.faceBrightening = parseInt(e.target.value);
                    faceBrighteningValue.textContent = e.target.value;
                    debouncedImageUpdateWithHistogram();
                }
            },
            {
                element: faceSmoothnessSlider,
                callback: (e) => {
                    settings.faceSmoothness = parseInt(e.target.value);
                    faceSmoothnessValue.textContent = e.target.value;
                    debouncedImageUpdateWithHistogram();
                }
            }
        ]);
        

        
        // 无参数版本的updateImageFromCache函数
        async function updateImageFromCache() {
            // 当无参数调用时，使用从Basic.js导入的版本
            if (cachedImageData) {
                await basicUpdateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
            } else {
                // 如果没有缓存，调用updateImage函数
                await updateImage();
            }
        }

        // 使用新设置更新图像
        async function updateImageWithNewSettings() {
            if (!currentSelectedFile) return;
            
            try {
                statusMessage.textContent = '应用设置...';
                
                // 重新从文件读取数据，避免使用可能已被分离的 ArrayBuffer
                const arrayBuffer = await readFileAsArrayBuffer(currentSelectedFile);
                const bufferCopy = new Uint8Array(arrayBuffer);
                
                // 使用新设置重新打开文件
                await libraw.open(bufferCopy, settings);
                
                // 更新图像显示
                await updateImageFromCache();
                
                // 刷新图片细节显示
                refreshImageDetails();
                
                statusMessage.textContent = '设置已应用';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 1500);
            } catch (error) {
                console.error('应用新设置时出错:', error);
                statusMessage.textContent = '应用设置失败';
            }
        }
        
        // 更新图像显示
        async function updateImage() {
            try {
                // 优先使用缓存数据
                if (cachedImageData && cachedImageData.data) {
                    // 直接使用缓存数据进行渲染
                    await updateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
                    return;
                }
                
                // 如果没有缓存，从libraw获取图像数据
                const imageData = await libraw.imageData();
                
                if (!imageData || !imageData.data) {
                    console.error('无法获取图像数据');
                    return;
                }
                
                // 设置 canvas 尺寸
                canvas.width = imageData.width;
                canvas.height = imageData.height;
                
                // 处理 RGB 转 RGBA 格式转换
                if (imageData.colors === 3) {
                    // RGB 转 RGBA
                    const rgbaData = new Uint8ClampedArray(imageData.data.length * 4 / 3);
                    for (let i = 0, j = 0; i < imageData.data.length; i += 3, j += 4) {
                        rgbaData[j] = imageData.data[i];     // R
                        rgbaData[j + 1] = imageData.data[i + 1]; // G
                        rgbaData[j + 2] = imageData.data[i + 2]; // B
                        rgbaData[j + 3] = 255;              // A (不透明)
                    }
                    
                    // 应用对比度调整
                    const contrast = parseInt(contrastSlider.value);
                    if (contrast !== 0) {
                        applyContrast(rgbaData, contrast);
                    }
                    
                    // 降噪已在 applyAdjustmentsToCachedData 中处理，这里不需要重复调用
                    
                    // 应用锐化和清晰度调整
                    const sharpness = parseInt(sharpnessSlider.value);
                    const texture = parseInt(textureSlider.value);
                    if (sharpness > 0 || texture > 0) {
                        applyUnsharpMask(rgbaData, imageData.width, imageData.height, sharpness, texture);
                    }
                    
                    // 创建ImageData对象
                    const canvasImageData = ctx.createImageData(imageData.width, imageData.height);
                    canvasImageData.data.set(rgbaData);
                    
                    // 直接绘制到画布
                    ctx.putImageData(canvasImageData, 0, 0);
                } else {
                    // 已经是 RGBA 格式
                    const canvasImageData = ctx.createImageData(imageData.width, imageData.height);
                    canvasImageData.data.set(imageData.data);
                    ctx.putImageData(canvasImageData, 0, 0);
                }
            } catch (error) {
                console.error('更新图像时出错:', error);
            }
        }
        

        

        

        
        // 初始化滤镜模块
        const filterElements = {
            filterSelect,
            saveFilterButton,
            rawFileInput,
            resetButton,
            brightnessSlider,
            brightnessValue,
            exposureSlider,
            exposureValue,
            saturationSlider,
            saturationValue,
            contrastSlider,
            contrastValue,
            highlightsSlider,
            highlightsValue,
            shadowsSlider,
            shadowsValue,
            redTintSlider,
            redTintValue,
            greenTintSlider,
            greenTintValue,
            blueTintSlider,
            blueTintValue,
            whitesSlider,
            whitesValue,
            sharpnessSlider,
            sharpnessValue,
            noiseReductionSlider,
            noiseReductionValue,
            faceBrighteningSlider,
            faceBrighteningValue,
            faceSmoothnessSlider,
            faceSmoothnessValue
        };
        
        const filterManager = initFilterModule(
            filterElements,
            settings,
            resetAllParametersToDefault,
            () => {
                // 更新图像
                debouncedImageUpdate();
                // 更新直方图
                if (window.chartManager) {
                    window.chartManager.forceUpdateHistogram();
                }
            },
            updateWhiteBalanceCoefficients
        );
        
        // 实现点击图像容器查看大图功能
        const imageContainer = document.querySelector('.image-container');
        
        // 创建全屏预览模态框
        function createFullscreenModal() {
            // 检查模态框是否已存在
            if (document.getElementById('fullscreen-modal')) {
                return document.getElementById('fullscreen-modal');
            }
            
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.id = 'fullscreen-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            modal.style.display = 'none';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            modal.style.cursor = 'pointer';
            modal.style.transition = 'opacity 0.3s ease';
            
            // 创建关闭按钮
            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '20px';
            closeButton.style.right = '30px';
            closeButton.style.fontSize = '40px';
            closeButton.style.color = 'white';
            closeButton.style.backgroundColor = 'transparent';
            closeButton.style.border = 'none';
            closeButton.style.cursor = 'pointer';
            closeButton.style.outline = 'none';
            closeButton.style.userSelect = 'none';
            closeButton.style.zIndex = '1001';
            
            // 创建显示图像的容器
            const imageWrapper = document.createElement('div');
            imageWrapper.style.maxWidth = '90%';
            imageWrapper.style.maxHeight = '90%';
            imageWrapper.style.overflow = 'hidden';
            
            // 创建用于显示大图的canvas
            const fullscreenCanvas = document.createElement('canvas');
            fullscreenCanvas.id = 'fullscreen-canvas';
            fullscreenCanvas.style.maxWidth = '100%';
            fullscreenCanvas.style.maxHeight = '100vh';
            fullscreenCanvas.style.boxShadow = '0 0 30px rgba(255, 255, 255, 0.3)';
            
            // 组装元素
            imageWrapper.appendChild(fullscreenCanvas);
            modal.appendChild(closeButton);
            modal.appendChild(imageWrapper);
            document.body.appendChild(modal);
            
            // 添加关闭事件
            function closeModal() {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
            
            closeButton.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // 添加ESC键关闭功能
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    closeModal();
                }
            });
            
            return modal;
        }
        
        // 显示全屏预览
        function showFullscreenPreview() {
            // 检查是否有Canvas数据
            if (!canvas || canvas.width === 0 || canvas.height === 0) {
                return;
            }
            
            // 创建或获取模态框
            const modal = createFullscreenModal();
            const fullscreenCanvas = document.getElementById('fullscreen-canvas');
            // 明确指定使用sRGB颜色空间，与主canvas保持一致
            const fullscreenCtx = fullscreenCanvas.getContext('2d', { colorSpace: 'srgb' });
            
            // 设置全屏canvas尺寸为当前Canvas尺寸
            fullscreenCanvas.width = canvas.width;
            fullscreenCanvas.height = canvas.height;
            
            // 直接从当前Canvas获取图像数据（包含所有修改，包括颜色替换）
            const currentImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // 清空画布并绘制图像
            fullscreenCtx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
            fullscreenCtx.putImageData(currentImageData, 0, 0);
            
            // 显示模态框
            modal.style.display = 'flex';
            // 强制重排以启用过渡效果
            void modal.offsetWidth;
            modal.style.opacity = '1';
        }
        
 
        
        // 查看大屏图片按钮事件监听器
        fullscreenViewButton.addEventListener('click', showFullscreenPreview);
        
        // 缓存Canvas图像数据
        let cachedCanvasImageData = null;
        let lastCanvasUpdateTime = 0;
        
        // 获取Canvas图像数据（带缓存）
        function getCanvasImageData() {
            const now = performance.now();
            // 如果缓存数据存在且距离上次更新不到100ms，使用缓存
            if (cachedCanvasImageData && (now - lastCanvasUpdateTime) < 100) {
                return cachedCanvasImageData;
            }
            
            // 获取新的Canvas数据
            cachedCanvasImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            lastCanvasUpdateTime = now;
            return cachedCanvasImageData;
        }
        
        // 图片细节显示功能（优化版）
        function showImageDetails(mouseX, mouseY) {
            if (!cachedImageData || !cachedImageData.data) {
                return;
            }
            
            // 节流控制
            const now = performance.now();
            if (now - lastUpdateTime < UPDATE_THROTTLE) {
                return;
            }
            lastUpdateTime = now;
            
            // 计算在Canvas上的相对位置
            const canvasRect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / canvasRect.width;
            const scaleY = canvas.height / canvasRect.height;
            
            let canvasX, canvasY;
            
            if (isDetailFixed) {
                // 使用固定位置
                canvasX = fixedPosition.x;
                canvasY = fixedPosition.y;
            } else {
                // 使用鼠标位置
                canvasX = Math.floor((mouseX - canvasRect.left) * scaleX);
                canvasY = Math.floor((mouseY - canvasRect.top) * scaleY);
            }
            
            // 确保坐标在有效范围内
            if (canvasX < 0 || canvasX >= canvas.width || canvasY < 0 || canvasY >= canvas.height) {
                return;
            }
            
            // 使用缓存的Canvas图像数据
            const currentImageData = getCanvasImageData();
            const pixelIndex = (canvasY * canvas.width + canvasX) * 4;
            const r = currentImageData.data[pixelIndex];
            const g = currentImageData.data[pixelIndex + 1];
            const b = currentImageData.data[pixelIndex + 2];
            const a = currentImageData.data[pixelIndex + 3];
            
            // 更新像素信息显示
            pixelPosition.textContent = `${canvasX}, ${canvasY}`;
            pixelRgb.textContent = `(${r}, ${g}, ${b})`;
            
            // 计算亮度 (使用标准亮度公式)
            const brightness = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
            pixelBrightness.textContent = brightness;
            
            // 计算色相
            const hue = calculateHue(r, g, b);
            pixelHue.textContent = `${hue}°`;
            
            // 创建放大预览（异步执行，避免阻塞）
            requestAnimationFrame(() => {
                createZoomPreview(canvasX, canvasY);
            });
        }
        
        // 计算色相的函数
        function calculateHue(r, g, b) {
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const delta = max - min;
            
            if (delta === 0) return 0;
            
            let hue = 0;
            if (max === r) {
                hue = ((g - b) / delta) % 6;
            } else if (max === g) {
                hue = (b - r) / delta + 2;
            } else {
                hue = (r - g) / delta + 4;
            }
            
            hue = Math.round(hue * 60);
            return hue < 0 ? hue + 360 : hue;
        }
        
        // 创建放大预览（优化版）
        function createZoomPreview(centerX, centerY) {
            const zoomCtx = zoomCanvas.getContext('2d', { colorSpace: 'srgb' });
            const zoomSize = 100; // 放大区域大小
            const zoomFactor = 4; // 放大倍数
            
            // 计算源区域
            const sourceX = Math.max(0, centerX - zoomSize / 2);
            const sourceY = Math.max(0, centerY - zoomSize / 2);
            const sourceWidth = Math.min(zoomSize, canvas.width - sourceX);
            const sourceHeight = Math.min(zoomSize, canvas.height - sourceY);
            
            // 使用缓存的Canvas数据，避免重复获取
            const currentImageData = getCanvasImageData();
            
            // 创建临时canvas来绘制放大区域
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = sourceWidth;
            tempCanvas.height = sourceHeight;
            const tempCtx = tempCanvas.getContext('2d', { colorSpace: 'srgb' });
            
            // 从缓存的图像数据中提取区域
            const sourceImageData = new ImageData(sourceWidth, sourceHeight);
            for (let y = 0; y < sourceHeight; y++) {
                for (let x = 0; x < sourceWidth; x++) {
                    const srcIndex = ((sourceY + y) * canvas.width + (sourceX + x)) * 4;
                    const dstIndex = (y * sourceWidth + x) * 4;
                    sourceImageData.data[dstIndex] = currentImageData.data[srcIndex];
                    sourceImageData.data[dstIndex + 1] = currentImageData.data[srcIndex + 1];
                    sourceImageData.data[dstIndex + 2] = currentImageData.data[srcIndex + 2];
                    sourceImageData.data[dstIndex + 3] = currentImageData.data[srcIndex + 3];
                }
            }
            
            tempCtx.putImageData(sourceImageData, 0, 0);
            
            // 清空并绘制到放大canvas
            zoomCtx.clearRect(0, 0, zoomCanvas.width, zoomCanvas.height);
            zoomCtx.imageSmoothingEnabled = false; // 保持像素清晰
            zoomCtx.drawImage(tempCanvas, 0, 0, sourceWidth * zoomFactor, sourceHeight * zoomFactor);
            
            // 绘制中心十字线
            const centerPixelX = (centerX - sourceX) * zoomFactor;
            const centerPixelY = (centerY - sourceY) * zoomFactor;
            
            zoomCtx.strokeStyle = '#ff0000';
            zoomCtx.lineWidth = 1;
            zoomCtx.beginPath();
            zoomCtx.moveTo(centerPixelX, 0);
            zoomCtx.lineTo(centerPixelX, zoomCanvas.height);
            zoomCtx.moveTo(0, centerPixelY);
            zoomCtx.lineTo(zoomCanvas.width, centerPixelY);
            zoomCtx.stroke();
        }
        
        // 初始化图片细节面板
        function initializeImageDetailPanel() {
            pixelPosition.textContent = '请上传图片';
            pixelRgb.textContent = '-';
            pixelBrightness.textContent = '-';
            pixelHue.textContent = '-';
            
            // 清空放大预览
            const zoomCtx = zoomCanvas.getContext('2d', { colorSpace: 'srgb' });
            zoomCtx.clearRect(0, 0, zoomCanvas.width, zoomCanvas.height);
            zoomCtx.fillStyle = '#f8f9fa';
            zoomCtx.fillRect(0, 0, zoomCanvas.width, zoomCanvas.height);
            zoomCtx.fillStyle = '#6c757d';
            zoomCtx.font = '14px Arial';
            zoomCtx.textAlign = 'center';
            zoomCtx.fillText('无图片', zoomCanvas.width / 2, zoomCanvas.height / 2);
            
            // 初始化模式状态
            isDetailFixed = false;
            updateDetailModeIndicator();
        }
        
        // 初始化面板
        initializeImageDetailPanel();
        
        
        
        // 切换固定/跟随模式
        function toggleDetailMode(mouseX, mouseY) {
            if (!cachedImageData || !cachedImageData.data) {
                return;
            }
            
            if (isDetailFixed) {
                // 当前是固定模式，切换到跟随模式
                isDetailFixed = false;
                updateDetailModeIndicator();
            } else {
                // 当前是跟随模式，切换到固定模式
                const canvasRect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / canvasRect.width;
                const scaleY = canvas.height / canvasRect.height;
                
                fixedPosition.x = Math.floor((mouseX - canvasRect.left) * scaleX);
                fixedPosition.y = Math.floor((mouseY - canvasRect.top) * scaleY);
                
                // 确保坐标在有效范围内
                if (fixedPosition.x >= 0 && fixedPosition.x < canvas.width && 
                    fixedPosition.y >= 0 && fixedPosition.y < canvas.height) {
                    isDetailFixed = true;
                    updateDetailModeIndicator();
                }
            }
        }
        
        // 更新模式指示器
        function updateDetailModeIndicator() {
            const modeText = isDetailFixed ? '固定模式' : '跟随模式';
            const header = document.querySelector('.detail-header h4');
            header.textContent = `图片细节 - ${modeText}`;
            
            // 添加视觉反馈
            if (isDetailFixed) {
                imageDetailPanel.style.borderColor = '#e74c3c';
                imageDetailPanel.style.borderWidth = '2px';
            } else {
                imageDetailPanel.style.borderColor = 'var(--border-color)';
                imageDetailPanel.style.borderWidth = '1px';
            }
        }
        
        // 刷新图片细节显示
        function refreshImageDetails() {
            // 清除Canvas数据缓存，强制获取最新数据
            cachedCanvasImageData = null;
            lastCanvasUpdateTime = 0;
            
            if (isDetailFixed) {
                // 如果是固定模式，使用固定位置刷新
                const canvasRect = canvas.getBoundingClientRect();
                const mouseX = canvasRect.left + (fixedPosition.x * canvasRect.width / canvas.width);
                const mouseY = canvasRect.top + (fixedPosition.y * canvasRect.height / canvas.height);
                showImageDetails(mouseX, mouseY);
            }
            // 跟随模式不需要主动刷新，会在鼠标移动时自动更新
        }
        
        // 为Canvas添加鼠标事件（优化版）
        canvas.addEventListener('mousemove', (e) => {
            // 使用requestAnimationFrame来优化性能
            requestAnimationFrame(() => {
                showImageDetails(e.clientX, e.clientY);
            });
        }, { passive: true });
        
        canvas.addEventListener('click', (e) => {
            toggleDetailMode(e.clientX, e.clientY);
        });
        
        // 导出按钮事件监听器
        exportPngButton.addEventListener('click', async () => {
            try {
                // 使用当前文件名（如果有）或默认名称
                const baseFilename = currentSelectedFile ? currentSelectedFile.name.replace(/\.[^/.]+$/, '') : 'exported-image';
                
                // 检查是否有颜色替换历史记录
                const hasColorReplacements = window.getColorReplaceHistory && window.getColorReplaceHistory().length > 0;
                
                if (!hasColorReplacements) {
                    // 没有颜色替换时，正常处理图像调整
                    statusMessage.textContent = '正在应用所有颜色调整...';
                    updateWhiteBalanceCoefficients(settings);
                    await updateImageFromCache();
                } else {
                    // 有颜色替换时，直接导出当前Canvas状态
                    statusMessage.textContent = '正在导出 PNG 图像（包含颜色替换）...';
                }
                
                statusMessage.textContent = '正在导出 PNG 图像...';
                await exportPNG(canvas, baseFilename);
                
                statusMessage.textContent = 'PNG 图像导出成功';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            } catch (error) {
                console.error('导出 PNG 图像失败:', error);
                statusMessage.textContent = '导出 PNG 图像失败';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            }
        });
        
        exportJpegButton.addEventListener('click', async () => {
            try {
                // 使用当前文件名（如果有）或默认名称
                const baseFilename = currentSelectedFile ? currentSelectedFile.name.replace(/\.[^/.]+$/, '') : 'exported-image';
                
                // 检查是否有颜色替换历史记录
                const hasColorReplacements = window.getColorReplaceHistory && window.getColorReplaceHistory().length > 0;
                
                if (!hasColorReplacements) {
                    // 没有颜色替换时，正常处理图像调整
                    statusMessage.textContent = '正在应用所有颜色调整...';
                    updateWhiteBalanceCoefficients(settings);
                    await updateImageFromCache();
                } else {
                    // 有颜色替换时，直接导出当前Canvas状态
                    statusMessage.textContent = '正在导出 JPEG 图像（包含颜色替换）...';
                }
                
                statusMessage.textContent = '正在导出 JPEG 图像...';
                await exportJPEG(canvas, 0.9, baseFilename);
                
                statusMessage.textContent = 'JPEG 图像导出成功';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            } catch (error) {
                console.error('导出 JPEG 图像失败:', error);
                statusMessage.textContent = '导出 JPEG 图像失败';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            }
        });
        
    
        
        
        // 暴露清除图像处理缓存的方法供颜色替换模块调用
        window.clearImageProcessingCache = function() {
            lastProcessedSettings = null;
            processedImageData = null;
            console.log('已清除图像处理缓存');
        };
        
        // 暴露获取当前Canvas状态的方法
        window.getCurrentCanvasState = function() {
            if (canvas.width > 0 && canvas.height > 0) {
                return ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            return null;
        };
        
        
        // 保存颜色替换后的基准数据
        window.saveColorReplaceBaseData = function(imageData) {
            colorReplaceBaseImageData = {
                data: new Uint8ClampedArray(imageData.data),
                width: imageData.width,
                height: imageData.height
            };
            console.log('已保存颜色替换基准数据');
        };
        
        // 清除颜色替换基准数据
        window.clearColorReplaceBaseData = function() {
            colorReplaceBaseImageData = null;
            console.log('已清除颜色替换基准数据');
        };
        
        // 重置到颜色替换基准状态（清除所有基本设置调整）
        window.resetToColorReplaceBase = function() {
            if (colorReplaceBaseImageData && colorReplaceBaseImageData.data) {
                // 重置所有基本设置为默认值
                settings.bright = 1.0;
                settings.exp_shift = 0.0;
                settings.user_sat = 100;
                settings.contrast = 0;
                settings.shadows = 0;
                settings.highlights = 0;
                settings.whites = 100;
                settings.user_mul = [1.0, 1.0, 1.0, 1.0];
                
                // 更新UI控件
                brightnessSlider.value = 1.0;
                brightnessValue.textContent = '1.0';
                exposureSlider.value = 0.0;
                exposureValue.textContent = '0.0';
                saturationSlider.value = 100;
                saturationValue.textContent = '100';
                contrastSlider.value = 0;
                contrastValue.textContent = '0';
                shadowsSlider.value = 0;
                shadowsValue.textContent = '0';
                highlightsSlider.value = 0;
                highlightsValue.textContent = '0';
                whitesSlider.value = 100;
                whitesValue.textContent = '100';
                
                // 直接显示基准图像
                const imageData = new ImageData(colorReplaceBaseImageData.data, colorReplaceBaseImageData.width, colorReplaceBaseImageData.height);
                ctx.putImageData(imageData, 0, 0);
                
                // 清除处理缓存
                lastProcessedSettings = null;
                processedImageData = null;
                
                console.log('已重置到颜色替换基准状态');
            } else {
                console.warn('没有颜色替换基准数据可重置');
            }
        };
        
        // 初始化图表模块
        const histogramCanvas = document.getElementById('histogram-canvas');
        const chartOptions = {
            sliders: document.querySelectorAll('input[type="range"]'),
            exportButtons: document.querySelectorAll('button[onclick^="exportImage"]')
        };
        
        window.chartManager = initChartModule(histogramCanvas, canvas, ctx, chartOptions);
    </script>
</body>
</html>