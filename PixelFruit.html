<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像素果</title>
    <!-- 模块通过ES模块导入，不需要这些script标签 -->
    <!-- <script type="module" src="color.js" defer></script> -->
    <!-- <script type="module" src="Basic.js" defer></script> -->
    <link rel="icon" href="./Logo/Logo.png" type="image/png">
    <!-- 引入外部CSS样式文件 -->
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    
    <div class="container">
        <!-- 左侧面板：文件上传和基本设置 -->
        <div class="left-panel">
            <div class="panel">
                <div class="panel-header">
                    <h3>文件上传</h3>
                </div>
                <div class="file-input">
                    <input type="file" id="raw-file" accept=".cr2,.nef,.arw,.dng,.raw,.rw2">
                    <label for="raw-file" class="file-input-label">选择 RAW 文件</label>
                    <div class="file-name" id="file-name">未选择文件</div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <h3>基本设置</h3>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="use-auto-wb" checked>
                        自动白平衡
                    </label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="use-camera-wb">
                        相机白平衡
                    </label>
                </div>
                <div class="slider-group">
                    <label for="brightness">亮度</label>
                    <div class="slider-wrapper">
                        <input type="range" id="brightness" min="0.1" max="4" step="0.1" value="1">
                        <span class="value-display" id="brightness-value">1.0</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label for="exposure">曝光补偿</label>
                    <div class="slider-wrapper">
                        <input type="range" id="exposure" min="-2" max="2" step="0.1" value="0">
                        <span class="value-display" id="exposure-value">0.0</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label for="saturation">饱和度</label>
                    <div class="slider-wrapper">
                        <input type="range" id="saturation" min="0" max="300" step="1" value="100">
                        <span class="value-display" id="saturation-value">100</span>
                    </div>
                </div>
                <div class="slider-group">
                    <label for="contrast">对比度</label>
                    <div class="slider-wrapper">
                        <input type="range" id="contrast" min="-50" max="50" step="1" value="0">
                        <span class="value-display" id="contrast-value">0</span>
                    </div>
                </div>
                
                <!-- 滤镜选择器 -->
                <div class="filter-group">
                    <label for="filter-select">预设滤镜</label>
                    <div class="filter-controls">
                        <select id="filter-select" class="filter-select">
                            <option value="none">无滤镜</option>
                        </select>
                        <button id="save-filter-button" class="save-filter-button" disabled>保存当前配置</button>
                    </div>
                </div>
                <div class="button-group">
                    <button id="reset-button" class="reset-button" disabled>重置</button>
                    <button id="export-png-button" class="export-button" disabled>导出 PNG</button>
                    <button id="export-jpeg-button" class="export-button" disabled>导出 JPEG</button>
                </div>
            </div>
        </div>
        
        <!-- 中间面板：图像显示 -->
        <div class="center-panel">
            <div class="image-container">
                <canvas id="image-canvas"></canvas>
                <div class="status-message" id="status-message">请上传 RAW 文件以查看图像</div>
            </div>
            
            <!-- 曲线调整面板已移除 -->
        </div>
        
        <!-- 右侧面板：高级设置 -->
        <div class="right-panel">
            <div class="panel">
                <div class="tabs">
                    <button class="tab active" data-tab="color">颜色调整</button>
                    <button class="tab" data-tab="detail">细节处理</button>
                    <button class="tab" data-tab="perspective">透视校正</button>
                </div>
                
                <div class="tab-content active" id="color-tab">
                    <div class="color-adjustments">
                        <div class="color-slider">
                            <label for="red-tint">红色色调</label>
                            <input type="range" id="red-tint" min="-100" max="100" step="1" value="0">
                        </div>
                        <div class="color-slider">
                            <label for="green-tint">绿色色调</label>
                            <input type="range" id="green-tint" min="-100" max="100" step="1" value="0">
                        </div>
                        <div class="color-slider">
                            <label for="blue-tint">蓝色色调</label>
                            <input type="range" id="blue-tint" min="-100" max="100" step="1" value="0">
                        </div>
                        <div class="color-slider">
                            <label for="highlights">高光</label>
                            <input type="range" id="highlights" min="-50" max="50" step="1" value="0">
                        </div>
                        <div class="color-slider">
                            <label for="shadows">阴影</label>
                            <input type="range" id="shadows" min="-50" max="50" step="1" value="0">
                        </div>
                        <div class="color-slider">
                            <label for="whites">白色</label>
                            <input type="range" id="whites" min="0" max="100" step="1" value="100">
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="detail-tab">
                    <div class="slider-group">
                        <label for="sharpness">锐化</label>
                        <div class="slider-wrapper">
                            <input type="range" id="sharpness" min="0" max="100" step="1" value="0">
                            <span class="value-display" id="sharpness-value">0</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label for="noise-reduction">减少杂色</label>
                        <div class="slider-wrapper">
                            <input type="range" id="noise-reduction" min="0" max="100" step="1" value="0">
                            <span class="value-display" id="noise-reduction-value">0</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label for="noise-reduction-type">降噪算法</label>
                        <select id="noise-reduction-type" class="control-select">
                            <option value="mean">均值滤波 (标准)</option>
                            <option value="median">中值滤波 (椒盐噪点)</option>
                            <option value="gaussian">高斯滤波 (平滑)</option>
                        </select>
                    </div>
                    <div class="slider-group">
                        <label for="detail-preservation">细节保留</label>
                        <div class="slider-wrapper">
                            <input type="range" id="detail-preservation" min="0" max="100" step="1" value="50">
                            <span class="value-display" id="detail-preservation-value">50</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label>降噪预设</label>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-preset="low">低降噪</button>
                            <button class="preset-btn" data-preset="medium">中降噪</button>
                            <button class="preset-btn" data-preset="high">高降噪</button>
                            <button class="preset-btn" data-preset="luminance">亮度降噪</button>
                            <button class="preset-btn" data-preset="color">色彩降噪</button>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label for="texture">纹理/清晰度</label>
                        <div class="slider-wrapper">
                            <input type="range" id="texture" min="-50" max="50" step="1" value="0">
                            <span class="value-display" id="texture-value">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="perspective-tab">
                    <div class="perspective-controls">
                        <div class="slider-group">
                            <label for="vertical-tilt">垂直倾斜</label>
                            <input type="range" id="vertical-tilt" min="-10" max="10" step="0.1" value="0">
                        </div>
                        <div class="slider-group">
                            <label for="horizontal-tilt">水平倾斜</label>
                            <input type="range" id="horizontal-tilt" min="-10" max="10" step="0.1" value="0">
                        </div>
                        <div class="slider-group">
                            <label for="rotate">旋转</label>
                            <input type="range" id="rotate" min="-180" max="180" step="1" value="0">
                        </div>
                        <div class="slider-group">
                            <label for="scale">缩放</label>
                            <input type="range" id="scale" min="50" max="200" step="1" value="100">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="histogram-panel">
                <div class="panel">
                    <div class="panel-header">
                        <h3>直方图</h3>
                        <div class="histogram-controls">
                            <button class="histogram-btn active" data-mode="luminance">亮度</button>
                            <button class="histogram-btn" data-mode="rgb">RGB</button>
                        </div>
                    </div>
                    <canvas id="histogram-canvas"></canvas>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <h3>图像元数据</h3>
                </div>
                <div class="metadata" id="metadata-output">请上传 RAW 文件以查看元数据</div>
            </div>
        </div>
    </div>

    <script type="module">
        import LibRaw from './index.js';
        import { initColorModule, applyColorAdjustments, updateWhiteBalanceCoefficients, applyContrast, registerColorEventListeners } from './Files/color.js';
        import { applyUnsharpMask, applySharpness, applyNoiseReduction, getNoiseReductionPreset } from './Files/Details.js';
        
        // 获取DOM元素
        const rawFileInput = document.getElementById('raw-file');
        const fileName = document.getElementById('file-name');
        const metadataOutput = document.getElementById('metadata-output');
        const canvas = document.getElementById('image-canvas');
        const ctx = canvas.getContext('2d');
        const statusMessage = document.getElementById('status-message');
        const resetButton = document.getElementById('reset-button');
        const exportPngButton = document.getElementById('export-png-button');
        const exportJpegButton = document.getElementById('export-jpeg-button');
        
        // 获取所有控件元素
        const useAutoWbCheckbox = document.getElementById('use-auto-wb');
        const useCameraWbCheckbox = document.getElementById('use-camera-wb');
        const brightnessSlider = document.getElementById('brightness');
        const brightnessValue = document.getElementById('brightness-value');
        const exposureSlider = document.getElementById('exposure');
        const exposureValue = document.getElementById('exposure-value');
        const saturationSlider = document.getElementById('saturation');
        const saturationValue = document.getElementById('saturation-value');
        const sharpnessSlider = document.getElementById('sharpness');
        const sharpnessValue = document.getElementById('sharpness-value');
        const noiseReductionSlider = document.getElementById('noise-reduction');
        const noiseReductionValue = document.getElementById('noise-reduction-value');
        const textureSlider = document.getElementById('texture');
        const textureValue = document.getElementById('texture-value');
        const contrastSlider = document.getElementById('contrast');
        const contrastValue = document.getElementById('contrast-value');
        const redTintSlider = document.getElementById('red-tint');
        const greenTintSlider = document.getElementById('green-tint');
        const blueTintSlider = document.getElementById('blue-tint');
        const highlightsSlider = document.getElementById('highlights');
        const shadowsSlider = document.getElementById('shadows');
        const whitesSlider = document.getElementById('whites');
        const verticalTiltSlider = document.getElementById('vertical-tilt');
        const horizontalTiltSlider = document.getElementById('horizontal-tilt');
        const rotateSlider = document.getElementById('rotate');
        const scaleSlider = document.getElementById('scale');
        const noiseReductionTypeSelect = document.getElementById('noise-reduction-type');
        const detailPreservationSlider = document.getElementById('detail-preservation');
        const detailPreservationValue = document.getElementById('detail-preservation-value');
        // 曲线编辑器已移除
        const filterSelect = document.getElementById('filter-select');
        const saveFilterButton = document.getElementById('save-filter-button');
        
        // 标签页相关元素
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // 初始化颜色模块
        // 创建colorElements对象并传递给color.js模块
        const colorElements = {
            brightnessSlider,
            brightnessValue,
            exposureSlider,
            exposureValue,
            saturationSlider,
            saturationValue,
            contrastSlider,
            contrastValue,
            redTintSlider,
            greenTintSlider,
            blueTintSlider,
            highlightsSlider,
            shadowsSlider,
            whitesSlider
        };
        
        // 初始化颜色模块
        initColorModule(colorElements);
        
        // 存储默认设置
        const defaultSettings = {
            use_auto_wb: 1,
            use_camera_wb: 0,
            bright: 1.0,
            exp_shift: 0.0,
            user_sat: 100,
            fbdd_noiserd: 0,
            user_mul: [1.0, 1.0, 1.0, 1.0],
            output_color: 1,
            output_bps: 8,
            half_size: 0,
            exp_correc: 1,
            adjust_maximum_thr: 0.75,
            shadows: 0
        };
        
        // 存储滤镜预设
        let filterPresets = {    
            '高对比度': {
                bright: 1.0,
                exp_shift: 0.1,
                user_sat: 120,
                highlights: 10,
                shadows: -10,
                contrast: 20
            },
            '复古胶片': {
                bright: 0.9,
                exp_shift: 0.0,
                user_sat: 110,
                highlights: -5,
                shadows: 10,
                red_tint: 5,
                green_tint: -3,
                blue_tint: -10
            },
            '风景模式': {
                bright: 1.1,
                exp_shift: 0.2,
                user_sat: 130,
                highlights: -10,
                shadows: 5,
                green_tint: 5,
                blue_tint: 5
            },
            '黑白模式': {
                bright: 1.0,
                exp_shift: 0.0,
                user_sat: 0,
                contrast: 15
            }
        };
        
        // 配置参数
        let settings = { ...defaultSettings };
        
        // 存储当前的文件数据
        let currentFileBuffer = null;
        // 缓存处理后的图像数据
        let cachedImageData = null;
        
        // 降噪相关的当前设置
        let currentNoiseReductionSettings = {
            type: 'mean',
            detailPreservation: 50
        };

        // 创建 LibRaw 实例
        const libraw = new LibRaw();
        
        // 从Basic.js导入基础功能函数，为debounce添加别名避免冲突
        const { debounce: debounceUtil, readFileAsArrayBuffer, updateImageFromCache: basicUpdateImageFromCache, exportImage } = await import('./Files/Basic.js');
        
        // 从Correction.js导入校正模块
        const { correctionModule } = await import('./Files/Correction.js');
        
        // 全局变量保存当前选择的文件对象
        let currentSelectedFile;
        
        // 创建统一的防抖图像处理函数
        const debouncedImageUpdate = debounceUtil(async () => {
            if (cachedImageData) {
                await updateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
            }
        }, 66); // 约15fps的刷新率，平衡响应速度和性能
        
        // 初始化校正模块
        correctionModule.init(debouncedImageUpdate);
        
        // 初始化滤镜选择器
        function initFilterSelector() {
            // 清空现有选项（保留默认的"无滤镜"选项）
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            // 添加滤镜预设选项
            for (const presetName in filterPresets) {
                const option = document.createElement('option');
                option.value = presetName;
                option.textContent = presetName;
                filterSelect.appendChild(option);
            }
        }
        
        // 应用滤镜预设
        function applyFilterPreset(presetName) {
            if (presetName === 'none' || !filterPresets[presetName]) {
                return;
            }
            
            const preset = filterPresets[presetName];
            
            // 首先将所有参数重置为默认值，确保滤镜切换时不会残留之前的设置
            // 亮度
            brightnessSlider.value = 1.0;
            brightnessValue.textContent = '1.0';
            settings.bright = 1.0;
            
            // 曝光补偿
            exposureSlider.value = 0;
            exposureValue.textContent = '0.0';
            settings.exp_shift = 0;
            
            // 饱和度
            saturationSlider.value = 100;
            saturationValue.textContent = '100';
            settings.user_sat = 100;
            
            // 对比度
            contrastSlider.value = 0;
            contrastValue.textContent = '0';
            
            // 高光
            highlightsSlider.value = 0;
            settings.highlights = 0;
            
            // 阴影
            shadowsSlider.value = 0;
            settings.shadows = 0;
            
            // 颜色色调
            redTintSlider.value = 0;
            greenTintSlider.value = 0;
            blueTintSlider.value = 0;
            
            // 应用预设值到设置对象
            for (const key in preset) {
                switch (key) {
                    case 'bright':
                        brightnessSlider.value = preset[key];
                        brightnessValue.textContent = preset[key].toFixed(1);
                        settings[key] = preset[key];
                        break;
                    case 'exp_shift':
                        exposureSlider.value = preset[key];
                        exposureValue.textContent = preset[key].toFixed(1);
                        settings[key] = preset[key];
                        break;
                    case 'user_sat':
                        saturationSlider.value = preset[key];
                        saturationValue.textContent = preset[key];
                        settings[key] = preset[key];
                        break;
                    case 'contrast':
                        contrastSlider.value = preset[key];
                        contrastValue.textContent = preset[key];
                        break;
                    case 'highlights':
                        highlightsSlider.value = preset[key];
                        settings[key] = preset[key];
                        break;
                    case 'shadows':
                        shadowsSlider.value = preset[key];
                        settings[key] = preset[key];
                        break;
                    case 'red_tint':
                        redTintSlider.value = preset[key];
                        break;
                    case 'green_tint':
                        greenTintSlider.value = preset[key];
                        break;
                    case 'blue_tint':
                        blueTintSlider.value = preset[key];
                        break;
                    // 添加其他需要的参数处理
                }
            }
            
            // 触发图像更新
            if (cachedImageData) {
                debouncedImageUpdate();
                // 触发直方图更新
                updateHistogram();
            }
        }
        
        // 保存当前配置为新的滤镜预设
        function saveCurrentConfigAsPreset() {
            const presetName = prompt('请输入滤镜名称:', '新滤镜' + (Object.keys(filterPresets).length + 1));
            
            if (!presetName || presetName.trim() === '') {
                alert('滤镜名称不能为空！');
                return;
            }
            
            // 获取当前所有设置
            const currentConfig = {
                bright: parseFloat(brightnessSlider.value),
                exp_shift: parseFloat(exposureSlider.value),
                user_sat: parseInt(saturationSlider.value),
                contrast: parseInt(contrastSlider.value),
                highlights: parseInt(highlightsSlider.value),
                shadows: parseInt(shadowsSlider.value),
                red_tint: parseInt(redTintSlider.value),
                green_tint: parseInt(greenTintSlider.value),
                blue_tint: parseInt(blueTintSlider.value)
                // 添加其他需要保存的参数
            };
            
            // 保存预设
            filterPresets[presetName] = currentConfig;
            
            // 更新选择器
            initFilterSelector();
            
            // 选择新保存的预设
            filterSelect.value = presetName;
            
            alert('滤镜预设 "' + presetName + '" 已保存！');
        }

        // 应用调整到缓存数据
        function applyAdjustmentsToCachedData(data, width, height) {
            // 获取锐化值
            const sharpness = settings.sharpness !== undefined ? settings.sharpness : parseInt(sharpnessSlider.value);
            
            // 获取降噪值
            const noiseReduction = settings.fbdd_noiserd !== undefined ? settings.fbdd_noiserd : parseInt(noiseReductionSlider.value);
            
            // 标记是否需要进行调整
            const needSharpness = sharpness > 0;
            const needNoiseReduction = noiseReduction > 0;
            
            // 应用颜色调整（从color.js模块）
            applyColorAdjustments(data, width, height, settings);
            
            // 先应用降噪
            if (needNoiseReduction) {
                // 使用新的增强版降噪函数，传入更多参数
                applyNoiseReduction(
                    data, 
                    width, 
                    height, 
                    noiseReduction, 
                    currentNoiseReductionSettings.type,
                    currentNoiseReductionSettings.detailPreservation
                );
            }
            
            // 然后应用锐化（在所有其他调整之后进行）
            if (needSharpness) {
                applySharpness(data, width, height, sharpness);
            }
        }
        


        // 从缓存更新图像

        
        // 监听文件选择
        rawFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            // 保存当前选择的文件对象
            currentSelectedFile = file;
            
            // 显示文件名
            fileName.textContent = file.name;
            
            try {
                // 读取文件数据
                const arrayBuffer = await readFileAsArrayBuffer(file);
                
                // 创建一个 Uint8Array 视图用于传递给 Web Worker
                currentFileBuffer = new Uint8Array(arrayBuffer);
                
                // 启用按钮
                resetButton.disabled = false;
                exportPngButton.disabled = false;
                exportJpegButton.disabled = false;
                
                // 显示处理状态
                statusMessage.textContent = '正在处理 RAW 文件...';
                metadataOutput.textContent = '正在提取元数据...';
                
                // 使用新设置重新打开文件
                await libraw.open(currentFileBuffer, settings);
                
                // 获取元数据
                const metadata = await libraw.metadata(true);
                metadataOutput.textContent = JSON.stringify(metadata, null, 2);
                
                // 获取并缓存图像数据
                try {
                    const imageData = await libraw.imageData();
                    if (imageData && imageData.data) {
                        // 处理RGB转RGBA的通道转换
                        let rgbaData = imageData.data;
                        if (imageData.colors === 3) {
                            // RGB转RGBA
                            rgbaData = new Uint8ClampedArray(imageData.data.length * 4 / 3);
                            for (let i = 0, j = 0; i < imageData.data.length; i += 3, j += 4) {
                                rgbaData[j] = imageData.data[i];     // R
                                rgbaData[j + 1] = imageData.data[i + 1]; // G
                                rgbaData[j + 2] = imageData.data[i + 2]; // B
                                rgbaData[j + 3] = 255;              // A (不透明)
                            }
                        }
                        
                        // 创建缓存的ImageData对象
                        cachedImageData = {
                            data: new Uint8ClampedArray(rgbaData),
                            width: imageData.width,
                            height: imageData.height
                        };
                    }
                } catch (error) {
                    console.error('缓存图像数据失败:', error);
                }
            // 显示初始图像
            await updateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
                
                // 隐藏处理状态
                statusMessage.textContent = '处理完成';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
                
                // 更新直方图
                updateHistogram();
            } catch (error) {
                console.error('处理文件时出错:', error);
                statusMessage.textContent = '处理失败';
                metadataOutput.textContent = `处理文件时出错: ${error.message}`;
            }
        });
        
        // 校正模块已处理垂直倾斜、水平倾斜、旋转和缩放滑块的事件监听器
        
        // 重置按钮点击事件
        resetButton.addEventListener('click', () => {
            // 重置设置
            settings = { ...defaultSettings };
            
            // 重置控件值
            useAutoWbCheckbox.checked = true;
            useCameraWbCheckbox.checked = false;
            brightnessSlider.value = 1.0;
            brightnessValue.textContent = '1.0';
            exposureSlider.value = 0.0;
            exposureValue.textContent = '0.0';
            saturationSlider.value = 100;
            saturationValue.textContent = '100';
            sharpnessSlider.value = 0;
            sharpnessValue.textContent = '0';
            noiseReductionSlider.value = 0;
            noiseReductionValue.textContent = '0';
            noiseReductionTypeSelect.value = 'mean';
            detailPreservationSlider.value = 50;
            detailPreservationValue.textContent = '50';
            textureSlider.value = 0;
            textureValue.textContent = '0';
            contrastSlider.value = 0;
            contrastValue.textContent = '0';
            redTintSlider.value = 0;
            greenTintSlider.value = 0;
            blueTintSlider.value = 0;
            highlightsSlider.value = 0;
            shadowsSlider.value = 0;
            whitesSlider.value = 100;
            verticalTiltSlider.value = 0;
            horizontalTiltSlider.value = 0;
            rotateSlider.value = 0;
            scaleSlider.value = 100;
            
            // 重置降噪设置
            currentNoiseReductionSettings = {
                type: 'mean',
                detailPreservation: 50
            };
            
            // 重新应用设置
            updateImageWithNewSettings();
        });
        
        // 监听控件变化 - 已通过 registerColorEventListeners 函数处理
        // 监听控件变化 - 已通过 registerColorEventListeners 函数处理
        
        // 初始化降噪相关控件的值显示
        detailPreservationValue.textContent = detailPreservationSlider.value;
        
        brightnessSlider.addEventListener('input', (e) => {
            settings.bright = parseFloat(e.target.value);
            brightnessValue.textContent = settings.bright.toFixed(1);
            // 使用防抖处理的图像更新
            debouncedImageUpdate();
        });
        
        exposureSlider.addEventListener('input', (e) => {
            settings.exp_shift = parseFloat(e.target.value);
            exposureValue.textContent = settings.exp_shift.toFixed(1);
            // 使用防抖处理的图像更新
            debouncedImageUpdate();
        });
        
        // 降噪滑块事件监听
        noiseReductionSlider.addEventListener('input', (e) => {
            settings.fbdd_noiserd = parseInt(e.target.value);
            noiseReductionValue.textContent = settings.fbdd_noiserd;
            debouncedImageUpdate();
        });
        
        // 降噪算法选择事件监听
        noiseReductionTypeSelect.addEventListener('change', (e) => {
            currentNoiseReductionSettings.type = e.target.value;
            debouncedImageUpdate();
        });
        
        // 细节保留滑块事件监听
        detailPreservationSlider.addEventListener('input', (e) => {
            currentNoiseReductionSettings.detailPreservation = parseInt(e.target.value);
            detailPreservationValue.textContent = currentNoiseReductionSettings.detailPreservation;
            debouncedImageUpdate();
        });
        
        // 降噪预设按钮事件监听
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const presetName = e.target.dataset.preset;
                const preset = getNoiseReductionPreset(presetName);
                
                // 应用预设值
                noiseReductionSlider.value = preset.strength;
                noiseReductionValue.textContent = preset.strength;
                settings.fbdd_noiserd = preset.strength;
                
                noiseReductionTypeSelect.value = preset.type;
                currentNoiseReductionSettings.type = preset.type;
                
                detailPreservationSlider.value = preset.detailPreservation;
                detailPreservationValue.textContent = preset.detailPreservation;
                currentNoiseReductionSettings.detailPreservation = preset.detailPreservation;
                
                debouncedImageUpdate();
            });
        });
        
        brightnessSlider.addEventListener('input', (e) => {
            settings.bright = parseFloat(e.target.value);
            brightnessValue.textContent = settings.bright.toFixed(1);
            // 使用防抖处理的图像更新
            debouncedImageUpdate();
        });
        
        exposureSlider.addEventListener('input', (e) => {
            settings.exp_shift = parseFloat(e.target.value);
            exposureValue.textContent = settings.exp_shift.toFixed(1);
            // 使用防抖处理的图像更新
            debouncedImageUpdate();
        });
        
        // 所有颜色调整滑块的事件监听器已通过 registerColorEventListeners 函数处理
        
        // 标签页切换
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有活动状态
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // 添加当前活动状态
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
        

        
        // 防抖处理颜色调整
        const debouncedColorUpdate = debounceUtil(() => {
            updateWhiteBalanceCoefficients(settings);
            if (cachedImageData) {
                debouncedImageUpdate();
            }
        }, 300);
        
        // 使用 color.js 中的函数注册所有颜色调整事件监听器
        registerColorEventListeners(settings, debouncedImageUpdate, debouncedColorUpdate);
        
        // 添加降噪滑块的事件监听器
        noiseReductionSlider.addEventListener('input', (e) => {
            settings.fbdd_noiserd = parseInt(e.target.value);
            noiseReductionValue.textContent = settings.fbdd_noiserd;
            // 使用防抖处理的图像更新
            debouncedImageUpdate();
        });
        

        
        // 无参数版本的updateImageFromCache函数
        async function updateImageFromCache() {
            // 当无参数调用时，使用从Basic.js导入的版本
            if (cachedImageData) {
                await basicUpdateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
            } else {
                // 如果没有缓存，调用updateImage函数
                await updateImage();
            }
        }

        // 使用新设置更新图像
        async function updateImageWithNewSettings() {
            if (!currentSelectedFile) return;
            
            try {
                statusMessage.textContent = '应用设置...';
                
                // 重新从文件读取数据，避免使用可能已被分离的 ArrayBuffer
                const arrayBuffer = await readFileAsArrayBuffer(currentSelectedFile);
                const bufferCopy = new Uint8Array(arrayBuffer);
                
                // 使用新设置重新打开文件
                await libraw.open(bufferCopy, settings);
                
                // 更新图像显示
                await updateImageFromCache();
                
                statusMessage.textContent = '设置已应用';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 1500);
            } catch (error) {
                console.error('应用新设置时出错:', error);
                statusMessage.textContent = '应用设置失败';
            }
        }
        
        // 更新图像显示
        async function updateImage() {
            try {
                // 优先使用缓存数据
                if (cachedImageData && cachedImageData.data) {
                    // 直接使用缓存数据进行渲染
                    await updateImageFromCache(cachedImageData, cachedImageData.width, cachedImageData.height, ctx, canvas, applyAdjustmentsToCachedData);
                    return;
                }
                
                // 如果没有缓存，从libraw获取图像数据
                const imageData = await libraw.imageData();
                
                if (!imageData || !imageData.data) {
                    console.error('无法获取图像数据');
                    return;
                }
                
                // 设置 canvas 尺寸
                canvas.width = imageData.width;
                canvas.height = imageData.height;
                
                // 创建 ImageData 对象并绘制到 canvas
                // 处理 RGB 转 RGBA 格式转换
                if (imageData.colors === 3) {
                    // RGB 转 RGBA
                    const rgbaData = new Uint8ClampedArray(imageData.data.length * 4 / 3);
                    for (let i = 0, j = 0; i < imageData.data.length; i += 3, j += 4) {
                        rgbaData[j] = imageData.data[i];     // R
                        rgbaData[j + 1] = imageData.data[i + 1]; // G
                        rgbaData[j + 2] = imageData.data[i + 2]; // B
                        rgbaData[j + 3] = 255;              // A (不透明)
                    }
                    
                    // 应用对比度调整
                    const contrast = parseInt(contrastSlider.value);
                    if (contrast !== 0) {
                        applyContrast(rgbaData, contrast);
                    }
                    
                    // 应用降噪
                    const noiseReduction = parseInt(noiseReductionSlider.value);
                    if (noiseReduction > 0) {
                        applyNoiseReduction(rgbaData, imageData.width, imageData.height, noiseReduction);
                    }
                    
                    // 应用锐化和清晰度调整
                    const sharpness = parseInt(sharpnessSlider.value);
                    const texture = parseInt(textureSlider.value);
                    if (sharpness > 0 || texture > 0) {
                        applyUnsharpMask(rgbaData, imageData.width, imageData.height, sharpness, texture);
                    }
                    
                    // 创建ImageData对象
                    const canvasImageData = ctx.createImageData(imageData.width, imageData.height);
                    canvasImageData.data.set(rgbaData);
                    
                    // 应用透视和旋转调整
                    // 由于 applyPerspectiveTransform 函数会直接绘制到主画布，我们需要先清空主画布
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // 使用校正模块应用透视变换
                    correctionModule.applyPerspectiveTransform(canvasImageData, ctx, canvas);
                } else {
                    // 已经是 RGBA 格式
                    const canvasImageData = ctx.createImageData(imageData.width, imageData.height);
                    canvasImageData.data.set(imageData.data);
                    ctx.putImageData(canvasImageData, 0, 0);
                }
            } catch (error) {
                console.error('更新图像时出错:', error);
            }
        }
        

        

        

        
        // 初始化滤镜选择器
        window.addEventListener('load', () => {
            initFilterSelector();
        });
        
        // 为滤镜选择器添加事件监听器
        filterSelect.addEventListener('change', (e) => {
            applyFilterPreset(e.target.value);
        });
        
        // 为保存滤镜按钮添加事件监听器
        saveFilterButton.addEventListener('click', saveCurrentConfigAsPreset);
        
        // 当图像加载后启用保存滤镜按钮
        rawFileInput.addEventListener('change', () => {
            saveFilterButton.disabled = false;
        });
        
        // 当重置设置时，重置滤镜选择器
        resetButton.addEventListener('click', () => {
            filterSelect.value = 'none';
        });
        
        // 实现点击图像容器查看大图功能
        const imageContainer = document.querySelector('.image-container');
        
        // 创建全屏预览模态框
        function createFullscreenModal() {
            // 检查模态框是否已存在
            if (document.getElementById('fullscreen-modal')) {
                return document.getElementById('fullscreen-modal');
            }
            
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.id = 'fullscreen-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            modal.style.display = 'none';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            modal.style.cursor = 'pointer';
            modal.style.transition = 'opacity 0.3s ease';
            
            // 创建关闭按钮
            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '20px';
            closeButton.style.right = '30px';
            closeButton.style.fontSize = '40px';
            closeButton.style.color = 'white';
            closeButton.style.backgroundColor = 'transparent';
            closeButton.style.border = 'none';
            closeButton.style.cursor = 'pointer';
            closeButton.style.outline = 'none';
            closeButton.style.userSelect = 'none';
            closeButton.style.zIndex = '1001';
            
            // 创建显示图像的容器
            const imageWrapper = document.createElement('div');
            imageWrapper.style.maxWidth = '90%';
            imageWrapper.style.maxHeight = '90%';
            imageWrapper.style.overflow = 'hidden';
            
            // 创建用于显示大图的canvas
            const fullscreenCanvas = document.createElement('canvas');
            fullscreenCanvas.id = 'fullscreen-canvas';
            fullscreenCanvas.style.maxWidth = '100%';
            fullscreenCanvas.style.maxHeight = '100vh';
            fullscreenCanvas.style.boxShadow = '0 0 30px rgba(255, 255, 255, 0.3)';
            
            // 组装元素
            imageWrapper.appendChild(fullscreenCanvas);
            modal.appendChild(closeButton);
            modal.appendChild(imageWrapper);
            document.body.appendChild(modal);
            
            // 添加关闭事件
            function closeModal() {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            }
            
            closeButton.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // 添加ESC键关闭功能
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    closeModal();
                }
            });
            
            return modal;
        }
        
        // 显示全屏预览
        function showFullscreenPreview() {
            // 只有当有图像数据时才显示预览
            if (!cachedImageData || !cachedImageData.data) {
                return;
            }
            
            // 创建或获取模态框
            const modal = createFullscreenModal();
            const fullscreenCanvas = document.getElementById('fullscreen-canvas');
            const fullscreenCtx = fullscreenCanvas.getContext('2d');
            
            // 设置全屏canvas尺寸为原始图像尺寸
            fullscreenCanvas.width = cachedImageData.width;
            fullscreenCanvas.height = cachedImageData.height;
            
            // 创建临时数组进行处理，避免直接修改缓存数据
            const tempData = new Uint8ClampedArray(cachedImageData.data.length);
            tempData.set(cachedImageData.data);
            
            // 应用当前调整到缓存数据
            applyAdjustmentsToCachedData(tempData, cachedImageData.width, cachedImageData.height);
            
            // 创建ImageData对象
            const imageData = new ImageData(tempData, cachedImageData.width, cachedImageData.height);
            
            // 清空画布并绘制图像
            fullscreenCtx.clearRect(0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
            fullscreenCtx.putImageData(imageData, 0, 0);
            
            // 显示模态框
            modal.style.display = 'flex';
            // 强制重排以启用过渡效果
            void modal.offsetWidth;
            modal.style.opacity = '1';
        }
        
        // 为图像容器添加点击事件监听器
        imageContainer.addEventListener('click', showFullscreenPreview);
        
        // 为了提升用户体验，添加鼠标悬停效果
        imageContainer.style.cursor = 'pointer';
        imageContainer.style.transition = 'transform 0.2s ease';
        
        imageContainer.addEventListener('mouseenter', () => {
            if (cachedImageData && cachedImageData.data) {
                imageContainer.style.transform = 'scale(1.01)';
            }
        });
        
        imageContainer.addEventListener('mouseleave', () => {
            imageContainer.style.transform = 'scale(1)';
        });
        
        // 导出按钮事件监听器
        exportPngButton.addEventListener('click', async () => {
            try {
                // 使用当前文件名（如果有）或默认名称
                const baseFilename = currentSelectedFile ? currentSelectedFile.name.replace(/\.[^/.]+$/, '') : 'exported-image';
                
                statusMessage.textContent = '正在导出 PNG 图像...';
                await exportImage(canvas, 'png', 1.0, baseFilename);
                statusMessage.textContent = 'PNG 图像导出成功';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            } catch (error) {
                console.error('导出 PNG 图像失败:', error);
                statusMessage.textContent = '导出 PNG 图像失败';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            }
        });
        
        exportJpegButton.addEventListener('click', async () => {
            try {
                // 使用当前文件名（如果有）或默认名称
                const baseFilename = currentSelectedFile ? currentSelectedFile.name.replace(/\.[^/.]+$/, '') : 'exported-image';
                
                statusMessage.textContent = '正在导出 JPEG 图像...';
                await exportImage(canvas, 'jpeg', 0.9, baseFilename);
                statusMessage.textContent = 'JPEG 图像导出成功';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            } catch (error) {
                console.error('导出 JPEG 图像失败:', error);
                statusMessage.textContent = '导出 JPEG 图像失败';
                setTimeout(() => {
                    statusMessage.textContent = '';
                }, 2000);
            }
        });
        
        // 直方图功能实现
        const histogramCanvas = document.getElementById('histogram-canvas');
        const histogramCtx = histogramCanvas.getContext('2d');
        
        // 确保canvas有适当的尺寸
        function resizeHistogramCanvas() {
            const parentWidth = histogramCanvas.parentElement.clientWidth;
            histogramCanvas.width = parentWidth - 20; // 考虑内边距
            histogramCanvas.height = 150;
        }
        
        // 初始化时调整尺寸
        resizeHistogramCanvas();
        
        // 窗口大小变化时重新调整尺寸
        window.addEventListener('resize', resizeHistogramCanvas);
        
        // 绘制空直方图
        function drawEmptyHistogram() {
            histogramCtx.clearRect(0, 0, histogramCanvas.width, histogramCanvas.height);
            
            // 绘制坐标轴
            histogramCtx.strokeStyle = '#ccc';
            histogramCtx.lineWidth = 1;
            
            // 底部坐标轴
            histogramCtx.beginPath();
            histogramCtx.moveTo(0, histogramCanvas.height - 1);
            histogramCtx.lineTo(histogramCanvas.width, histogramCanvas.height - 1);
            histogramCtx.stroke();
            
            // 左侧坐标轴
            histogramCtx.beginPath();
            histogramCtx.moveTo(1, 0);
            histogramCtx.lineTo(1, histogramCanvas.height);
            histogramCtx.stroke();
            
            // 显示提示文字
            histogramCtx.fillStyle = '#999';
            histogramCtx.font = '14px Arial';
            histogramCtx.textAlign = 'center';
            histogramCtx.textBaseline = 'middle';
            histogramCtx.fillText('请上传图像以查看直方图', histogramCanvas.width / 2, histogramCanvas.height / 2);
        }
        
        // 绘制直方图
        function drawHistogram(histogramData) {
            if (!histogramData || !histogramData.length) {
                drawEmptyHistogram();
                return;
            }
            
            // 清空画布
            histogramCtx.clearRect(0, 0, histogramCanvas.width, histogramCanvas.height);
            
            const mode = document.querySelector('.histogram-btn.active').dataset.mode;
            const barWidth = Math.max(1, histogramCanvas.width / 256);
            
            // 找出最大值用于归一化
            let maxValue = 0;
            for (let i = 0; i < histogramData.length; i++) {
                if (mode === 'rgb') {
                    maxValue = Math.max(maxValue, histogramData[i].r, histogramData[i].g, histogramData[i].b);
                } else {
                    maxValue = Math.max(maxValue, histogramData[i].l);
                }
            }
            
            // 绘制直方图
            for (let i = 0; i < 256; i++) {
                const x = i * barWidth;
                
                if (mode === 'rgb') {
                    // RGB模式：分别绘制红、绿、蓝通道
                    const rHeight = (histogramData[i].r / maxValue) * histogramCanvas.height;
                    const gHeight = (histogramData[i].g / maxValue) * histogramCanvas.height;
                    const bHeight = (histogramData[i].b / maxValue) * histogramCanvas.height;
                    
                    // 蓝色
                    histogramCtx.fillStyle = 'rgba(0, 0, 255, 0.6)';
                    histogramCtx.fillRect(x, histogramCanvas.height - bHeight, barWidth, bHeight);
                    
                    // 绿色
                    histogramCtx.fillStyle = 'rgba(0, 255, 0, 0.6)';
                    histogramCtx.fillRect(x, histogramCanvas.height - gHeight, barWidth, gHeight);
                    
                    // 红色
                    histogramCtx.fillStyle = 'rgba(255, 0, 0, 0.6)';
                    histogramCtx.fillRect(x, histogramCanvas.height - rHeight, barWidth, rHeight);
                } else {
                    // 亮度模式
                    const height = (histogramData[i].l / maxValue) * histogramCanvas.height;
                    histogramCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    histogramCtx.fillRect(x, histogramCanvas.height - height, barWidth, height);
                }
            }
            
            // 绘制坐标轴
            histogramCtx.strokeStyle = '#ccc';
            histogramCtx.lineWidth = 1;
            
            // 底部坐标轴
            histogramCtx.beginPath();
            histogramCtx.moveTo(0, histogramCanvas.height - 1);
            histogramCtx.lineTo(histogramCanvas.width, histogramCanvas.height - 1);
            histogramCtx.stroke();
            
            // 左侧坐标轴
            histogramCtx.beginPath();
            histogramCtx.moveTo(1, 0);
            histogramCtx.lineTo(1, histogramCanvas.height);
            histogramCtx.stroke();
        }
        
        // 计算直方图数据
        function calculateHistogram(imageData) {
            if (!imageData || !imageData.data) {
                return null;
            }
            
            const data = imageData.data;
            const histogram = [];
            
            // 初始化直方图数组
            for (let i = 0; i < 256; i++) {
                histogram[i] = { r: 0, g: 0, b: 0, l: 0 };
            }
            
            // 计算每个像素的颜色值出现频率
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                // 计算亮度 (简单的灰度转换公式)
                const l = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                
                histogram[r].r++;
                histogram[g].g++;
                histogram[b].b++;
                histogram[l].l++;
            }
            
            return histogram;
        }
        
        // 更新直方图
        function updateHistogram() {
            try {
                if (!canvas || !cachedImageData || !cachedImageData.data) {
                    drawEmptyHistogram();
                    return;
                }
                
                // 创建临时数组进行处理
                const tempData = new Uint8ClampedArray(cachedImageData.data.length);
                tempData.set(cachedImageData.data);
                
                // 应用当前调整到缓存数据
                applyAdjustmentsToCachedData(tempData, cachedImageData.width, cachedImageData.height);
                
                // 创建ImageData对象
                const imageData = new ImageData(tempData, cachedImageData.width, cachedImageData.height);
                
                // 计算直方图数据
                const histogramData = calculateHistogram(imageData);
                
                // 绘制直方图
                drawHistogram(histogramData);
            } catch (error) {
                console.error('更新直方图时出错:', error);
                drawEmptyHistogram();
            }
        }
        
        // 添加直方图模式切换按钮事件
        document.querySelectorAll('.histogram-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // 移除所有按钮的active类
                document.querySelectorAll('.histogram-btn').forEach(b => b.classList.remove('active'));
                // 为当前按钮添加active类
                this.classList.add('active');
                // 重新绘制直方图
                updateHistogram();
            });
        });
        
        // 监听图像画布变化，更新直方图
        const updateHistogramDebounced = debounceUtil(updateHistogram, 100); // 使用从Basic.js导入的debounceUtil函数
        
        // 尝试获取导出按钮，添加点击事件
        const exportButtons = document.querySelectorAll('button[onclick^="exportImage"]');
        exportButtons.forEach(button => {
            button.addEventListener('click', function() {
                setTimeout(updateHistogram, 50); // 稍微延迟，确保图像已经更新
            });
        });
        
        // 为颜色调整滑块添加事件监听
        const sliders = document.querySelectorAll('input[type="range"]');
        sliders.forEach(slider => {
            slider.addEventListener('input', updateHistogramDebounced);
        });
        
        // 暴露更新直方图的方法供外部调用
        window.updateHistogram = updateHistogram;
        
        // 初始绘制空直方图
        drawEmptyHistogram();
    </script>
</body>
</html>